---
layout:     post
title:      "定位段错误"
subtitle:   ""
date:       2012-05-07 20:00:00
author:     "lyremelody"
header-img: "img/post-bg-2015.jpg"
catalog: true
tags:
    - 段错误
    - Linux调试
    - "core dump"
---


　　在Linux下开发，一个令人头疼的问题就是段错误，有时候程序跑着跑着突然就挂掉，提示“Segmentation fault”。以前比较麻烦的方法就是用gdb设断点，一步一步跟踪，看是到哪里出了问题，费时费力。如果程序稍微大点，那就非常的麻烦了。

　　其实有个相当简单快速定位的方法，那就是分析断错误产生的core文件。

　　首先需要通过ulimit -c unlimited 开启程序崩溃时产生core文件。

　　然后当产生段错误时，使用gdb加载执行程序及core文件，使用bt（或者where）打印堆栈信息。

　　示例如下：

	/* test.cpp */
	#include <stdio.h>
	#include <stdlib.h>
	char* myStrcpy (char* dist, char* src)
	{
		while (*src != '\0')
			*dist++ *src++;
		*dist = '\0';
	}

	int main ()
	{
		char *arr = (char*)malloc (10 * sizeof (char));
		myStrcpy (arr, "abcd");
		printf ("%s\n", arr);

		char *err = NULL;
		myStrcpy (err, "abcd");
		return 0;
	}
	
　　编译test。

	g++ -o -g test test.cpp

　　执行test时，输出如下：

	[root@localhost test]# ./main
	abcd
	段错误 (core dumped)

　　这时候查看目录下的文件，多了个core.3809文件，用gdb加载

	[root@localhost test]# gdb main core.3809
	GNU gdb Red Hat Linux (6.5-37.el5rh)
	Copyright (C) 2006 Free Software Foundation, Inc.
	GDB is free software, covered by the GNU General Public License, and you are
	welcome to change it and/or distribute copies of it under certain conditions.
	Type "show copying" to see the conditions.
	There is absolutely no warranty for GDB.  Type "show warranty" for details.
	This GDB was configured as "x86_64-redhat-linux-gnu"…Using host libthread_db library "/lib64/libthread_db.so.1".
	
	warning: Can't read pathname for load map: 输入/输出错误.
	Reading symbols from /usr/lib64/libstdc++.so.6…done.
	Loaded symbols for /usr/lib64/libstdc++.so.6
	Reading symbols from /lib64/libm.so.6…done.
	Loaded symbols for /lib64/libm.so.6
	Reading symbols from /lib64/libgcc_s.so.1…done.
	Loaded symbols for /lib64/libgcc_s.so.1
	Reading symbols from /lib64/libc.so.6…done.
	Loaded symbols for /lib64/libc.so.6
	Reading symbols from /lib64/ld-linux-x86-64.so.2…done.
	Loaded symbols for /lib64/ld-linux-x86-64.so.2
	Core was generated by `./main'.
	Program terminated with signal 11, Segmentation fault.
	#0  0x00000000004005c1 in myStrcpy (dist=0×0, src=0x40071c "abcd") at main.cpp:8
	8            *dist++ = *src++;

　　这里已经定位到是main.cpp的第8行出的问题，当然还可以用bt（或where）查看详细的堆栈信息

	(gdb) bt
	#0  0x00000000004005c1 in myStrcpy (dist=0×0, src=0x40071c "abcd") at main.cpp:8
	#1  0×0000000000400623 in main () at main.cpp:20

　　这样很快就能看出时err未分配内存导致的内存访问错误，是不是很方便呢？

